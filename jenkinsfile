pipeline {
  agent { node { label 'Node1' } }
  environment {
    PATH = '/var/lib/jenkins/.nvm/versions/node/v14.21.2/bin:/usr/local/rvm/gems/ruby-2.4.0/bin:/usr/local/rvm/gems/ruby-2.4.0@global/bin:/usr/local/rvm/rubies/ruby-2.4.0/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/local/rvm/bin:/var/lib/jenkins/.local/bin:/var/lib/jenkins/bin'
  }
  stages {
    stage('get excel and python script') {
      steps {
        echo 'Getting the excel and python files'
        sh '''ls -la
chmod 754 CSV_formatter.py
chmod 754 staging_mp_upload_rules.py
chmod 754 paul_staging_mp_redir_validation.py'''
      }
    }

    stage('Running formatter') {
      steps {
        echo 'Running CSV formatter and generating CSV files'
        sh 'python3 CSV_formatter.py'
        sh 'ls -la'
      }
    }

    stage('Upload Games') {
      steps {
        echo 'checking if there is a csv file for games'
        script {
          if (fileExists('games-upload-locale.csv')) {
            sh 'echo "uploading games rules"'
            sh 'python3 staging_mp_upload_rules.py games-upload-locale.csv'
            sh 'cp games-upload-locale.csv /var/lib/jenkins/resources_edgekv/production/games-upload-locale-`date +%Y-%m-%d-%H-%M`.csv'
          }
        }

      }
    }

    stage('Upload Support') {
      steps {
        echo 'Checking if there is a CSV file for support'
        script {
          if (fileExists('support-upload-locale.csv')) {
            sh 'echo "uploading support rules"'
            sh 'python3 staging_mp_upload_rules.py support-upload-locale.csv'
            sh 'cp support-upload-locale.csv /var/lib/jenkins/resources_edgekv/production/test-support-upload-locale-`date +%Y-%m-%d-%H-%M`.csv'
          }
        }

      }
    }

    stage('Upload General') {
      steps {
        echo 'Checking for CSV for General'
        script {
          if (fileExists('general-upload-locale.csv')) {
            sh 'echo "uploading general rules"'
            sh 'python3 staging_mp_upload_rules.py general-upload-locale.csv'
            sh 'cp general-upload-locale.csv /var/lib/jenkins/resources_edgekv/production/test-general-upload-locale-`date +%Y-%m-%d-%H-%M`.csv'
          }
        }

      }
    }

    stage('Testing All Redirects') {
      steps {
        echo 'Testing the uploaded rules'
        script {
          if (fileExists('test-uploader2.xlsx')) {
            sh 'echo "testing uploaded general rules"'
            sh 'python3 paul_staging_mp_redir_validation.py'
          }
        }

      }
    }

    stage('Delete environment') {
      steps {
        cleanWs(cleanWhenAborted: true, cleanWhenFailure: true, cleanWhenNotBuilt: true, cleanWhenSuccess: true)
      }
    }

  }
}